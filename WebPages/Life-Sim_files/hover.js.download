"use strict";(function(){"use strict";const c=window.SteamDB,K=!!document.querySelector(".header-user-avatar");let q=K?300:900;const he=K?175:300,g=document.querySelector(".hover_wrapper");if(!g)return;const i=g.querySelector("#js-hover");if(!i||!c)return;const C=new Map;let D=null,h=null,b=null,w=null,x=null,z=!0,H=null,p=null;const a=document.querySelector("#js-screenshots"),Z=document.body.dataset.storeAssets,O=new Image;O.fetchPriority="low";let d=null,_=0,v=0,ee=!1,I=null;c.RequirePageScreenshotViewer(ue,!0),pe(),g.addEventListener("click",ve),i.addEventListener("pointerenter",ye,{passive:!0}),i.addEventListener("pointerleave",Se,{passive:!0}),document.body.addEventListener("touchstart",me,{passive:!0}),c.BindHover=e=>se(e.querySelectorAll(".app")),c.HideHoverIfAny=f,c.OnExtensionUserdataLoaded(()=>{z=!1});function ve(e){e.target instanceof Element&&e.target.classList.contains("hover_mobile")&&oe(i)}let y=null,S=null,u=null,A=!1,M=!1,te=0;function me(e){if(e.touches.length!==1||!(e.target instanceof HTMLElement))return;const t=e.target.closest(".app, #js-hover");if(t){if(A=t.id==="js-hover",M=!1,A){if(i.scrollTop>0)return;te=Date.now(),t.classList.add("hover_dragging")}else{const n=re(t,0);if(n!==null&&n.scrollLeft!==0)return}u=t,y=S=e.touches.item(0),document.body.addEventListener("touchmove",ne,{passive:!0}),document.body.addEventListener("touchend",j,{passive:!0})}}function ne(e){const t=e.touches.item(0),n=t.screenX-y.screenX,o=t.screenY-y.screenY;if(A){if(S=t,M||i.scrollTop>0){M=!0,y=t;return}u.style.transform=`translate3d(0, ${Math.max(0,o)}px, 0)`;return}if(t.screenX<S.screenX||Math.abs(o/n)>=.3){u=null,j();return}S=t}function j(){if(document.body.removeEventListener("touchmove",ne),document.body.removeEventListener("touchend",j),u!==null){if(A){u.classList.remove("hover_dragging");const e=S.screenY-y.screenY,t=i.offsetHeight,n=Date.now()-te,o=e/n;e>t/3||o>.5?oe(u):u.style.transform="";return}if(S.screenX-y.screenX>100){const e=+u.dataset.appid,t=C.get(e);if(g.classList.add("hover_mobile"),document.documentElement.classList.add("js-hover-shown"),"CloseWatcher"in window&&(H=new window.CloseWatcher,H.addEventListener("close",()=>f(!0))),t){i.appendChild(t),B(t,null);return}le(e,null)}u=null}}function oe(e){if(e.hidden){f(!0);return}g.classList.add("hover_hiding"),e.addEventListener("transitionend",()=>f(),{once:!0}),e.style.transform=`translate3d(0, ${Math.max(0,e.offsetHeight)}px, 0)`}function re(e,t){return e===null||t>8?null:e.scrollWidth>e.clientWidth?e:re(e.parentElement,t+1)}function pe(){const e=typeof $=="function"&&typeof $.fn=="object"&&typeof $.fn.dataTable=="function";let t=e?[]:document.querySelectorAll(".app");e&&$($.fn.dataTable.tables()).each(function(){const n=$(this).DataTable().table();t=Array.from(n.rows(".app").nodes()),$(this).on("draw.dt",()=>f())}),se(t)}function se(e){for(const t of e)t.addEventListener("pointerenter",ie,{passive:!0}),t.addEventListener("pointerleave",ge,{passive:!0})}function ie(e){const t=e.target;if(e.pointerType!=="mouse"||!(t instanceof HTMLElement)||window.matchMedia("(max-width: 979px)").matches)return;if(h){b=e;return}const n=+t.dataset.appid,o=C.get(n);if(o){i.appendChild(o),B(o,t);return}f(),D=setTimeout(()=>{le(n,t)},q)}function le(e,t){if(w=new AbortController,fetch(`/api/RenderAppHover/?appid=${e}`,{headers:{Accept:"text/html","X-Requested-With":"XMLHttpRequest"},signal:w.signal}).then(n=>{if(!n.ok){n.status>=400&&n.status!==404&&(q=5e3);const o=new Error(`HTTP ${n.status}`);throw o.name="ServerError",o}return n.text()}).then(n=>{w=null,q=he,i.insertAdjacentHTML("beforeend",n);const o=i.lastElementChild;if(o instanceof HTMLElement){C.set(e,o),Ee(e,o);const r=o.querySelector(".js-open-screenshot-viewer");if(r&&r.dataset.screenshots){const s=r.dataset.screenshots.split(","),l=o.querySelector(".hover_title").textContent;ue(+r.dataset.appid,l,r,s)}B(o,t)}}).catch(n=>{if(n.name!=="AbortError"&&(f(!0),n.name!=="ServerError"))throw n}),!ee){ee=!0;const n=document.createElement("link");n.rel="preconnect",n.href=document.body.dataset.videoCdn,document.head.append(n)}}function f(e=!1){if(b=null,D&&(clearTimeout(D),D=null),h&&(clearTimeout(h),h=null),w&&(w.abort(),w=null),H&&(H.destroy(),H=null),x){i.scrollTop=0,i.hidden=!0,i.style.transform="";const t=x.querySelector("video");t&&t.remove(),x.remove(),x=null,e=!0}e&&(g.classList.remove("hover_mobile","hover_hiding"),document.documentElement.classList.remove("js-hover-shown"))}function ge(e){e.pointerType==="mouse"&&(b=null,!h&&(e.relatedTarget instanceof Element&&i.contains(e.relatedTarget)||(h=setTimeout(we,100))))}function we(){const e=b;f(),e&&ie(e)}function ye(){clearTimeout(h),h=null,b=null}function Se(e){e.pointerType==="mouse"&&f()}function B(e,t){x=e;const n=e.querySelector(".hover_video"),o=n?.dataset.microtrailer;if(o){const L=document.createElement("video");L.autoplay=!0,L.muted=!0,L.loop=!0,L.playsInline=!0;const He=document.body.dataset.videoCdn,fe=JSON.parse(o);for(const[Te,Ce]of Object.entries(fe.video)){const J=document.createElement("source");J.type=Te,J.src=`${He}store_trailers/${Ce}?t=${fe.time}`,L.append(J)}n.appendChild(L)}if(i.hidden=!1,t===null)return;const r=t.getBoundingClientRect(),s=document.documentElement.scrollTop,l=r.top+s,Le=r.bottom+s,Y=r.left+document.documentElement.scrollLeft,be=document.documentElement.clientWidth,V=document.documentElement.clientHeight,N=i.offsetWidth,T=i.offsetHeight,xe=be-(Y+r.width+N),Q=Y-N;let E=0,k="0",G="0";Q<0&&xe<0?(k=r.right-N+"px",l+T>V+s&&l-T>=s?E=l-T:E=Le):(Q<0?k=Y+r.width+"px":k=Q+"px",l+T>V+s?E=V+s-T:E=l),E<1?G="0":G=E+"px",i.style.transform=`translate3d(${k}, ${G}, 0)`}function m(e){v+=e,v<0?v=d.length-1:v%=d.length;let t=d[v];if(t.startsWith("https://")||(t=`${Z}apps/${_}/${t}`),a.querySelector(".screenshot-contain").style.backgroundImage=`url(${encodeURI(t)})`,a.querySelector(".screenshot-index").textContent=`${v+1} of ${d.length}`,a.querySelector(".screenshot-open").href=t,d.length>1){e===0&&(e=1);let n=v+e;n<0?n=d.length-1:n%=d.length,t=d[n],t.startsWith("https://")||(t=`${Z}apps/${_}/${t}`),O.src=t}}function ce(e){e.key==="ArrowLeft"?(e.preventDefault(),m(-1)):e.key==="ArrowRight"||e.key===" "?(e.preventDefault(),m(1)):e.key==="Escape"&&p===null&&(e.preventDefault(),W())}function ae(e){e.preventDefault(),!I&&(I=setTimeout(()=>{I=null},100),e.deltaY<0?m(-1):e.deltaY>0&&m(1))}function W(){document.documentElement.classList.remove("js-screenshots-shown"),document.removeEventListener("keydown",ce),document.removeEventListener("wheel",ae),document.removeEventListener("fullscreenchange",de),d=null,O.src="data:,",p&&(p.destroy(),p=null),document.fullscreenElement&&document.exitFullscreen().catch(()=>{})}function de(){p&&!document.fullscreenElement&&W()}a.querySelector(".screenshot-prev").addEventListener("click",e=>{e.preventDefault(),m(-1)}),a.querySelector(".screenshot-next").addEventListener("click",e=>{e.preventDefault(),m(1)}),a.querySelector(".screenshot-close").addEventListener("click",e=>{e.preventDefault(),W()}),a.querySelector(".screenshot-contain").addEventListener("click",e=>{e.preventDefault(),m(e.pageX/document.documentElement.clientWidth>=.5?1:-1)});function ue(e,t,n,o){const r=s=>{const l=a.querySelector(".screenshot-name");l.textContent=`SteamDB \u2014 ${t}`,l.href=`/app/${e}/`,v=s,_=e,d=o,m(0),document.documentElement.classList.add("js-screenshots-shown"),document.addEventListener("keydown",ce),document.addEventListener("wheel",ae,{passive:!1}),"CloseWatcher"in window&&(p=new window.CloseWatcher,p.addEventListener("close",W)),window.matchMedia("(max-width: 979px)").matches&&a.requestFullscreen&&(document.addEventListener("fullscreenchange",de),a.requestFullscreen().catch(()=>{}))};return n&&n.addEventListener("click",s=>{s.preventDefault(),r(0)}),{open:r}}function Ee(e,t){if(z)return;const n=t.querySelector(".hover_wishlist"),o=t.querySelector(".hover_follow"),r=t.querySelector(".hover_ignore"),s=t.querySelector(".hover_owned");c.OwnedApps.has(e)?s.hidden=!1:(c.FamilySharedApps.has(e)&&(s.textContent="In Family Library",s.classList.add("infamily"),s.hidden=!1),n&&(c.WishedApps.has(e)&&P(n,!0),n.hidden=!1,n.addEventListener("click",l=>{l.preventDefault(),F(n),R(e,c.WishedApps.has(e)?"StoreWishlistRemove":"StoreWishlistAdd")}))),o&&(c.FollowedApps.has(e)&&U(o,!0),o.hidden=!1,o.addEventListener("click",l=>{l.preventDefault(),F(o),R(e,c.FollowedApps.has(e)?"StoreUnfollow":"StoreFollow")})),r&&(c.IgnoredApps.has(e)&&X(r,!0),r.hidden=!1,r.addEventListener("click",l=>{l.preventDefault(),F(r),R(e,c.IgnoredApps.has(e)?"StoreUnignore":"StoreIgnore")}))}function F(e){e.innerHTML='<span class="loader"></span>'}function R(e,t){window.postMessage({type:"steamdb:extension-query",contentScriptQuery:t,appid:e},window.location.origin)}function P(e,t){e&&(e.classList.toggle("wished",t),e.textContent=t?"On Wishlist":"Wishlist")}function U(e,t){e&&(e.classList.toggle("followed",t),e.textContent=t?"Unfollow":"Follow")}function X(e,t){e&&(e.classList.toggle("ignored",t),e.textContent=t?"Unignore":"Ignore")}if("BroadcastChannel"in window)try{new BroadcastChannel("steamdb-extension").addEventListener("message",t=>{if(!(!t||t.origin!==window.location.origin)&&t.data&&t.data.type==="steamdb:extension-response"){if(!t.data.response||!t.data.response.success||!t.data.request.appid)return;const n=C.get(t.data.request.appid);if(!n)return;const o=n.querySelector(".hover_wishlist"),r=n.querySelector(".hover_follow"),s=n.querySelector(".hover_ignore");switch(t.data.request.contentScriptQuery){case"StoreWishlistAdd":P(o,!0);break;case"StoreWishlistRemove":P(o,!1);break;case"StoreFollow":U(r,!0);break;case"StoreUnfollow":U(r,!1);break;case"StoreIgnore":X(s,!0);break;case"StoreUnignore":X(s,!1);break}}})}catch{}})();
